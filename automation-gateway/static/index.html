<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automation 2040 W</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #0f1419; color: #e7e9ea; min-height: 100vh; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        h1 { font-size: 24px; margin-bottom: 8px; color: #f97316; }
        .subtitle { color: #71767b; margin-bottom: 24px; }
        .status { display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 20px; font-size: 14px; margin-bottom: 12px; margin-right: 8px; }
        .status.ok { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
        .status.err { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
        .card { background: #1a1f26; border: 1px solid #2f3336; border-radius: 12px; padding: 20px; margin-bottom: 16px; }
        .card h2 { font-size: 16px; margin-bottom: 16px; color: #e7e9ea; }
        .row-label { font-size: 12px; color: #71767b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .io-row { display: flex; gap: 12px; margin-bottom: 16px; }
        .io-row:last-child { margin-bottom: 0; }
        .io-item { flex: 1; background: #0f1419; border: 1px solid #2f3336; border-radius: 8px; padding: 12px; text-align: center; }
        .io-item.clickable { cursor: pointer; transition: all 0.15s; }
        .io-item.clickable:hover { border-color: #f97316; background: #1a1f26; }
        .io-item.clickable:active { transform: scale(0.97); }
        .io-label { font-size: 11px; color: #71767b; margin-bottom: 4px; }
        .io-value { font-size: 20px; font-weight: 700; }
        .io-value.on { color: #22c55e; }
        .io-value.off { color: #555; }
        .io-value.volt { color: #a855f7; }
        button { width: 100%; padding: 12px; background: #f97316; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 8px; }
        button:hover { background: #ea580c; }
        button.secondary { background: transparent; border: 1px solid #2f3336; color: #71767b; }
        .update-indicator { font-size: 11px; color: #71767b; text-align: right; margin-top: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Automation 2040 W</h1>
        <p class="subtitle">Control Panel</p>

        <div class="status" id="board-status"><span>Board: Loading...</span></div>
        <div class="status" id="mqtt-status"><span>MQTT: Loading...</span></div>
        <div class="subtitle" id="mqtt-info" style="font-size: 12px; margin-top: 4px; margin-bottom: 24px;"></div>
        <div class="card">
            <h2>I/O Status</h2>

            <div class="row-label">Relays</div>
            <div class="io-row" id="relays"></div>

            <div class="row-label">Outputs</div>
            <div class="io-row" id="outputs"></div>

            <div class="row-label">Digital Inputs</div>
            <div class="io-row" id="inputs"></div>

            <div class="row-label">Analog Inputs</div>
            <div class="io-row" id="adcs"></div>

            <div class="update-indicator">Auto-refresh: <span id="countdown">1</span>s</div>
        </div>

        <button class="secondary" onclick="resetAll()">
            Reset All Outputs
        </button>
    </div>

    <script>
        let countdown = 1;

        function updateHealth() {
            fetch('/api/health')
                .then(r => r.json())
                .then(data => {
                    const boardStatus = document.getElementById('board-status');
                    const mqttStatus = document.getElementById('mqtt-status');
                    const mqttInfo = document.getElementById('mqtt-info');

                    if (data.board_connected) {
                        boardStatus.className = 'status ok';
                        boardStatus.innerHTML = '<span>Board: Connected</span>';
                    } else {
                        boardStatus.className = 'status err';
                        boardStatus.innerHTML = '<span>Board: Disconnected</span>';
                    }

                    if (data.mqtt_connected) {
                        mqttStatus.className = 'status ok';
                        mqttStatus.innerHTML = '<span>MQTT: Connected</span>';
                        mqttInfo.textContent = `Broker: ${data.mqtt_broker} | Topic: ${data.mqtt_topic_prefix}/*`;
                    } else {
                        mqttStatus.className = 'status err';
                        mqttStatus.innerHTML = '<span>MQTT: Disconnected</span>';
                        mqttInfo.textContent = `Broker: ${data.mqtt_broker} (disconnected)`;
                    }
                })
                .catch(err => console.error('Health check failed:', err));
        }

        function toggleRelay(n) {
            const relays = document.querySelectorAll('#relay-' + n);
            if (relays.length === 0) return;

            const currentState = relays[0].classList.contains('on');

            fetch('/api/relay/' + n, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({state: !currentState})
            })
            .then(r => {
                if (!r.ok) throw new Error('Relay toggle failed');
                refresh();
            })
            .catch(err => {
                console.error(err);
            });
        }

        function toggleOutput(n) {
            const outputs = document.querySelectorAll('#output-' + n);
            if (outputs.length === 0) return;

            const currentValue = parseInt(outputs[0].dataset.value || '0');
            const newValue = currentValue > 0 ? 0 : 100;

            fetch('/api/output/' + n, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({value: newValue})
            })
            .then(r => {
                if (!r.ok) throw new Error('Output toggle failed');
                refresh();
            })
            .catch(err => {
                console.error(err);
            });
        }

        function resetAll() {
            fetch('/api/reset', {method: 'POST'})
                .then(r => {
                    if (!r.ok) throw new Error('Reset failed');
                    refresh();
                })
                .catch(err => {
                    console.error(err);
                });
        }

        function refresh() {
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    if (data.error) {
                        console.error('Status error:', data.error);
                        // keep UI as-is; no spinner
                        return;
                    }

                    // Build relays
                    const relaysDiv = document.getElementById('relays');
                    relaysDiv.innerHTML = '';
                    for (let i = 0; i < data.relays.length; i++) {
                        const state = data.relays[i];
                        const cls = state ? 'on' : 'off';
                        const val = state ? 'ON' : 'OFF';
                    relaysDiv.innerHTML += `<div class="io-item clickable" onclick="toggleRelay(${i+1})">
                            <div class="io-label">R${i+1}</div>
                            <div class="io-value ${cls}" id="relay-${i+1}">${val}</div>
                        </div>`;
                    }

                    // Build outputs
                    const outputsDiv = document.getElementById('outputs');
                    outputsDiv.innerHTML = '';
                    for (let i = 0; i < data.outputs.length; i++) {
                        const value = data.outputs[i];
                        const cls = value > 0 ? 'on' : 'off';
                        const val = value > 0 ? 'ON' : 'OFF';
                        outputsDiv.innerHTML += `<div class="io-item clickable" onclick="toggleOutput(${i+1})">
                            <div class="io-label">O${i+1}</div>
                            <div class="io-value ${cls}" id="output-${i+1}" data-value="${value}">${val}</div>
                        </div>`;
                    }

                    // Build inputs
                    const inputsDiv = document.getElementById('inputs');
                    inputsDiv.innerHTML = '';
                    for (let i = 0; i < data.inputs.length; i++) {
                        const state = data.inputs[i];
                        const cls = state ? 'on' : 'off';
                        const val = state ? 'HIGH' : 'LOW';
                        inputsDiv.innerHTML += `<div class="io-item">
                            <div class="io-label">I${i+1}</div>
                            <div class="io-value ${cls}" id="input-${i+1}">${val}</div>
                        </div>`;
                    }

                    // Build ADCs
                    const adcsDiv = document.getElementById('adcs');
                    adcsDiv.innerHTML = '';
                    for (let i = 0; i < data.adcs.length; i++) {
                        const voltage = data.adcs[i];
                        adcsDiv.innerHTML += `<div class="io-item">
                            <div class="io-label">A${i+1}</div>
                            <div class="io-value volt" id="adc-${i+1}">${voltage.toFixed(1)}V</div>
                        </div>`;
                    }
                })
                .catch(err => console.error('Refresh failed:', err));

            countdown = 1;
        }

        // Initial load
        updateHealth();
        refresh();

        // Auto-refresh
        setInterval(() => {
            countdown--;
            document.getElementById('countdown').textContent = countdown;
            if (countdown <= 0) {
                refresh();
                updateHealth();
            }
        }, 1000);
    </script>
</body>
</html>
